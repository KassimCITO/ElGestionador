{% extends "base.html" %}

{% block title %}Editar Persona{% endblock %}

{% block content %}
<h3 class="mb-4">Editar Persona</h3>
<form method="post" enctype="multipart/form-data">
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="nombre" class="form-label">Nombres</label>
            <input type="text" class="form-control" id="nombre" name="nombre" value="{{ persona.nombre }}" required>
        </div>
        <div class="col-md-4">
            <label for="apellido_paterno" class="form-label">Apellido Paterno</label>
            <input type="text" class="form-control" id="apellido_paterno" name="apellido_paterno" value="{{ persona.apellido_paterno }}" required>
        </div>
        <div class="col-md-4">
            <label for="apellido_materno" class="form-label">Apellido Materno</label>
            <input type="text" class="form-control" id="apellido_materno" name="apellido_materno" value="{{ persona.apellido_materno }}" required>
        </div>
    </div>
    <div class="mb-3">
        <label for="curp" class="form-label">CURP</label>
        <input type="text" class="form-control" id="curp" name="curp" value="{{ persona.curp }}" required>
    </div>
    <div class="mb-3">
        <label for="direccion" class="form-label">Dirección</label>
        <textarea class="form-control" id="direccion" name="direccion" rows="3" required>{{ persona.direccion }}</textarea>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <label for="colonia" class="form-label">Colonia</label>
            <input type="text" class="form-control" id="colonia" name="colonia" value="{{ persona.colonia }}" required>
        </div>
        <div class="col-md-6">
            <label for="cp" class="form-label">Código Postal</label>
            <input type="text" class="form-control" id="cp" name="cp" value="{{ persona.cp }}" required>
        </div>
        <div class="col-md-6">
            <label for="fecha_nac" class="form-label">Fecha de Nacimiento</label>
            <input type="date" class="form-control" id="fecha_nac" name="fecha_nac" value="{{ persona.fecha_nac }}" required>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="estado" class="form-label">Estado</label>
            <select class="form-select" id="estado" name="id_estado" required>
                <option value="">Selecciona un estado</option>
                {% for estado in estados %}
                    <option value="{{ estado.id }}" {% if persona.id_estado == estado.id %}selected{% endif %}>{{ estado.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="municipio" class="form-label">Municipio</label>
            <select class="form-select" id="municipio" name="id_municipio" required>
                <option value="">Selecciona un municipio</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="clave_elector" class="form-label">Clave de Elector</label>
            <input type="text" class="form-control" id="clave_elector" name="clave_elector" value="{{ persona.clave_elector }}" maxlength="18" required>
        </div>
    </div>
    <div class="mb-3">
        <label for="foto" class="form-label">Fotografía (dejar vacío para no cambiar)</label>
        <input type="file" class="form-control" id="foto" name="foto" accept="image/*">
    </div>
    {% if persona.foto %}
    <div class="mb-3">
        <p>Foto actual:</p>
        <img src="{{ url_for('static', filename='uploads/' + persona.foto) }}" class="rounded" width="120">
    </div>
    {% endif %}
    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
    <a href="{{ url_for('personas') }}" class="btn btn-secondary">Cancelar</a>
</form>

<!-- Serialización segura de municipios_json como JSON embebido -->
<script type="application/json" id="municipios-data">
{{ municipios_json|safe }}
</script>
<script>
    // Estructura: {id_estado: [{id, nombre}, ...]}
    var municipiosPorEstado = {};
    try {
        var raw = document.getElementById('municipios-data').textContent;
        municipiosPorEstado = JSON.parse(raw);
        if (typeof municipiosPorEstado !== 'object' || municipiosPorEstado === null) {
            municipiosPorEstado = {};
        }
    } catch (e) {
        console.error('Error al parsear municipiosPorEstado:', e);
        municipiosPorEstado = {};
    }
    console.log("municipiosPorEstado:", municipiosPorEstado); // DEBUG
    var estadoSelect = document.getElementById('estado');
    var municipioSelect = document.getElementById('municipio');
    function cargarMunicipios(idEstado) {
        municipioSelect.innerHTML = '<option value="">Selecciona un municipio</option>';
        var clave = String(idEstado);
        var lista = municipiosPorEstado[clave];
        console.log("Estado seleccionado:", clave, "Lista municipios:", lista); // DEBUG
        if (clave && Array.isArray(lista)) {
            lista.forEach(function(mun) {
                var option = document.createElement('option');
                option.value = mun.id;
                option.textContent = mun.nombre;
                municipioSelect.appendChild(option);
            });
            municipioSelect.disabled = false;
        } else {
            municipioSelect.disabled = true;
        }
    }
    estadoSelect.addEventListener('change', function() {
        cargarMunicipios(estadoSelect.value);
        municipioSelect.value = '';
    });
    document.addEventListener('DOMContentLoaded', function() {
        var estadoActual = estadoSelect.value;
        var municipioActual = "{{ persona.id_municipio|e('js') if persona.id_municipio else '' }}";
        if (estadoActual) {
            cargarMunicipios(estadoActual);
            // Selección robusta del municipio (comparando como string)
            Array.from(municipioSelect.options).forEach(function(opt) {
                if (String(opt.value) === String(municipioActual)) {
                    municipioSelect.value = opt.value;
                }
            });
        }
        municipioSelect.disabled = !estadoSelect.value;
    });
</script>
{% endblock %}
